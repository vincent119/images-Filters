# Image Processing Pipeline

[English](../image-pipeline.md)

## 概述

圖片處理流程描述了請求從接收到回應的生命週期。設計目標為高效能、快速失敗與頻繁快取。

### 工作流程步驟

1. **請求接收**
   - Gin 路由接收請求。
   - 範例: `GET /signature/300x200/image.jpg`

2. **驗證與解析**
   - **安全中介軟體**: 驗證 `signature` 是否符合路徑。
   - **解析器**: 將 `300x200` 解碼為 `ProcessingOptions` 結構。

3. **快取層 1 (讀取)**
   - 檢查鍵值（參數的雜湊）是否存在於 **Redis** (或記憶體)。
   - **命中 (HIT)**: 立即回傳快取圖片。
   - **未命中 (MISS)**: 繼續下一步驟。

4. **圖片載入**
   - **載入器**: 根據協定（`http://`, `s3://` 或本地檔案）獲取原始圖片。
   - 驗證圖片格式與標頭 (Magic Bytes)。

5. **處理核心**
   - **解碼**: 將原始位元組轉換為 Image 物件。
   - **操作**:
     - **縮放 (Resize)**: 使用 Lanczos 重採樣演算法。
     - **智慧裁切 (Smart Crop)**: (選用) 內容感知裁切。
     - **濾鏡**: 套用濾鏡鏈 (如模糊、灰階)。
   - **編碼**: 轉換回位元組格式 (JPEG/PNG/WebP)。

6. **快取層 2 (寫入)**
   - 將處理結果寫入快取並設定過期時間 (TTL)。

7. **回應**
   - 設定 `Content-Type` 與 HTTP 標頭。
   - 將位元組串流回傳給用戶端。
